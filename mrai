#!/bin/bash
# -*- coding: utf-8 -*-
#
#  mrai
#  
#  Copyright 2018 Thomas Castleman <draugeros@gmail.com>
#  
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#

#Start Defining Functions

#Install software from apt
aptinstall () {
	if $(apt search "$pass" | grep -q "$pass"); then
		if [ -f /etc/mrai/apt-fast.flag ]; then
			({
				#Install software using apt-fast, if available based on the apt-fast.flag
				#use pkexec to gain root privleges in order to install software
				pkexec apt-fast install "$pass" 
			} && {
			#update flags if snapd or flatpak get installed
				if [ "$pass" == "flatpak" ]; then
					echo "" >> /etc/mrai/flatpak.flag
				elif [ "$pass" == "snapd" ]; then
					echo "" >> /etc/mrai/snapd.flag
				fi
			}) || return 2
		else
			({
				#install software using apt, due to the unavailability of apt-fast
				pkexec apt install "$pass"
			} && {
			#update flags if snapd, flatpak, or apt-fast get installed
				if [ "$pass" == "apt-fast" ]; then
					echo "" >> /etc/mrai/apt-fast.flag
				elif [ "$pass" == "snapd" ]; then
					echo "" >> /etc/mrai/snapd.flag
				elif [ "$pass" == "flatpak" ]; then
					echo "" >> /etc/mrai/flatpak.flag
				fi
			}) || return 2
		fi
	else
		return 1
	fi
}

#install software, using a more automatic method, from GitHub
gitautoinst () {
	cd $HOME
	#make directory .mrai if it exists
	if [[ ! -d .mrai ]]; then
		mkdir .mrai
	fi
	cd .mrai
	#check to see how the URL to github is formatted
	#check for a VERY specific location
	if $(echo "$pass" | grep -q 'https://github.com/') || $(echo "$pass" | grep -q 'http://github.com/'); then
	        git clone "$pass"
	#check for a slightly less specific location
	elif $(echo "$pass" | grep -q 'github.com/'); then
	        git clone https://$pass
	#if they did not specifiy "GitHub.com", assume it.
	else 
	        git clone https://github.com/$pass
	fi
	#cd into the new directory git just make from the GitHub repo
	pass1=$(echo $pass | sed 's/.*\///')
	cd $pass1
	#Check for a Makefile
	if $(find Makefile) || $(find makefile); then
		#if a Makefile exists, run make depend to ensure we have all the dependencies we need
		make depend
		#run make && make install to install the new software, if make fails don't bother running make install since
		#it would most likely fail
	        make && make install
		#Back up the Makefile since it might be useful in uninstalling the software
		mkdir "$gitautocache"/"$z" && cp Makefile "$gitautocache"/"$pass1" || cd .. && rm -rf $pass1
		#make a deb as a back up for install/uninstall
		pkexec checkinstall
		#back up the deb to $gitautocache/#pass1
		deb=$(find -type f -name "*.deb")
		cp "$deb" "$gitautocache"/"$pass1"
		echo "ADDRESS=$pass" >> "$gitautocache"/auto.flag
        #copy Makefile to a directory in a good place in the file system. Name the directory it's in the value of $z
	else
	        cd ..
	        rm -rf $pass1
	fi
}

flatinstall () {
	if [ -f /etc/mrai/flatpak.flag ]; then
		loop=1
		while [ "$loop" == "1" ]; do
			q=$(flatpak search "$pass")
			r=$(echo "$q" | awk '{print $1}')
			if [ "$r" == "No matches found" ]; then
				list=$(flatpak remotes)
				if $(echo "$list" | grep -q 'flathub'); then
					echo -e "\nNo installation candidates found.\n"
					exit 1
				else
					flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
					continue
				fi
			elif $(echo "$r" | grep -q "org.") || $(echo "$r" | grep -q "com.") || $(echo "$r" | grep -q "ws."); then
				set -- "$r"
				test="$2"
				if [ -z "$test" ]; then		
					list=$(flatpak remotes)
					list1=$(echo "$list" | awk '{print $1}')
					echo -e "\nAttempting to install $r as a Flatpak. Please wait . . . \n"
					for entry in $list1; do
						flatpak install -y "$entry" "$r" && break || echo -e "\nFlatpak installation from $entry failed.\n"
					done
					loop="0"
				else
					echo -e "\nERROR: Multiple Installation Candidates Detected.\n"
					echo -e "Which package would you like to install?\n$r\n"
					read -p "Please copy-paste the name of the package here: " int
					flatpak install -y flathub "$int"
				fi
			else
				loop="0"
				exit 1
			fi
		done
	else
		if [ "$z" == "-f" ] || [ "$z" == "--flatpak" ]; then
			echo -e "\nSorry. Package 'flatpak' is not installed. Please run {mrai -i -a flatpak} to install it.\n"
			exit 2
		else
			return 2
		fi
	fi
			
}

snapinstall () {
	if [ -f /etc/mrai/snapd.flag ]; then
		if $(snap search "$pass" | grep -q "$pass"); then
			snap install "$pass" || read "Standard Snap Installation Failed. Attempt Classic Snap Installation? [y/N]: " ans
			if [ ! -z $ans ]; then
				if [ "$ans" == "Y" ] || [ "$ans" == "y" ]; then
					snap install "$pass" --classic || return 2
				else
					return 2
				fi
			fi
		else
			return 1
		fi
	else
		exit 1
	fi
}


gitmaninstall () {
	read -p "All other installation methods (apt, Snap, flatpak, automatic Github) have failed. Would you like to try manually installing from Github? [y/N]: " ans
	if [ "$ans" == "Y" ] || [ "$ans" == "y" ]; then
		cd $HOME
		mkdir .mrai
		cd .mrai
		if $(echo "$pass" | grep -q 'https://github.com/') || $(echo "$pass" | grep -q 'http://github.com/'); then
	        	git clone "$pass"
		elif $(echo "$pass" | grep -q 'github.com/'); then
		        git clone https://$pass
		else 
		        git clone https://github.com/$pass
		fi
		pass1=$(echo $pass | sed 's/.*\///')
		cd $pass1
		echo -e "\n$(ls)\n"
		read -p "Which of the above files would you like to try to run in order to install $z? (Case-Sensitive) : " run
		read -p "Should this file be run with root privleges? [y/N]: " ans
		ans=$(echo "$ans" | awk '{print tolower($0)}')
		if [ "$ans" == "y" ]; then
			chmod +x $(pwd)/$run
			pkexec $(pwd)/$run
			mkdir "$gitmancache"/"$pass1" && cp "$run" "$gitmancache"/"$pass1" || return 2
			pkexec checkinstall
			deb=$(find -type f -name "*.deb")
			cp "$deb" "$gitautocache"/"$pass1"
			echo "ADDRESS=$pass" >> "$gitmancache"/man.flag
			echo "RUN_AS_ROOT=yes" >> "$gitmancache"/man.flag
			echo "RUN=$run" >> "$gitmancache"/man.flag
		elif [ "$ans" == "n" ]; then
			chmod +x $(pwd)/$run
			exec $(pwd)/$run
			mkdir "$gitmancache"/"$pass1" && cp "$run" "$gitmancache"/"$pass1" || return 2
			pkexec checkinstall
			deb=$(find -type f -name "*.deb")
			cp "$deb" "$gitautocache"/"$pass1"
			echo "ADDRESS=$pass" >> "$gitmancache"/man.flag
			echo "RUN_AS_ROOT=no" >> "$gitmancache"/man.flag
			echo "RUN=$run" >> "$gitmancache"/man.flag
		elif [ "$ans" == "cancel" ] || [ "$ans" == "exit" ] || [ "$ans" == "end" ]; then
			echo -e "\nAborting . . .\n"
		else
			echo -e "\nInput not recognized. Running without root privileges\n"
			exec $(pwd)/$run
			mkdir "$gitmancache"/"$pass1" && cp "$run" "$gitmancache"/"$pass1" || return 2
			pkexec checkinstall
			deb=$(find -type f -name "*.deb")
			cp "$deb" "$gitautocache"/"$pass1"
			echo "ADDRESS=$pass" >> "$gitmancache"/man.flag
			echo "RUN_AS_ROOT=null" >> "$gitmancache"/man.flag
			echo "RUN=$run" >> "$gitmancache"/man.flag
		fi
	else
		echo -e "\nAborting Manual install from Github...\n"
		exit 1
	fi
}

aptremove () {
	pkexec apt purge "$pass"
	if [ "$pass" == "apt-fast" ]; then
		rm /etc/mrai/apt-fast.flag
	elif [ "$pass" == "snapd" ]; then
		rm /etc/mrai/snapd.flag
	elif [ "$pass" == "flatpak" ]; then
		rm /etc/mrai/flatpak.flag
	fi
}

gitremove () {
	if $(gitautolist | grep -q "$pass"); then
		cd "$gitautocache"/"$pass"
		if $( echo $(ls) | grep "Makefile"); then
			(( make uninstall || make remove ) || {
				if $(find -type f -name "*.deb"); then
					pak=$(find -type f -name "*.deb")
					pkexec apt-get remove $(pwd)/"$pak"
				else
					echo -e "\nMakefile uninstall method failed and no *.deb back-up file was found.\nPlease run \n{sudo checkinstall && cp \$(find -type f -name '*.deb') $gitautocache/$z\nThen run\npkexec apt-get location-of-package/package-name" && exit 2
				fi
			}) && {
				cd ..
				rm -rf "$pass"
				echo -e "\n$pass has been removed.\n"
				exit 0
			}
			
		elif $(echo $(ls) | grep ".deb"); then
			pak=$(find -type f -name "*.deb")
			pkexec apt-get remove $(pwd)/"$pak"
		else
			echo -e "\nWe're sorry. No Makefile or back-up *.deb file could be found. Therefor, mrai cannot uninstall $z\n"
		fi
	elif $(gitmanlist | grep -q "$pass"); then
		cd "$gitmancache"/"$pass"
		flag=$(ls | grep "man.flag")
		root=$(cat $flag | grep "RUN_AS_ROOT=")
		run=$(cat $flag | grep "RUN=")
		run=$(echo $run | sed 's/RUN=//')
		if [ "$root" == "RUN_AS_ROOT=yes" ]; then
			echo -e "\nAttempting to uninstall. Please wait . . .\n"
			sent=0
			num=1
			while [ "$sent" == "0" ]; do
				echo -e "\nTry $num . . .\n"
				if [ "$num" == "1" ]; then
					opt="remove"
				elif [ "$num" == "2" ]; then
					opt="--remove"
				elif [ "$num" == "3" ]; then
					opt="uninstall"
				elif [ "$num" == "4" ]; then
					opt="--uninstall"
				else
					echo -e "\nAll other options on the install script have failed. Please look online for documentation on how to remove this app.\nWe are sorry for any inconvenience.\n" && exit 2
				fi
				sleep 3s
				(( pkexec $(pwd)/"$run" "$opt" ) && ( sent=1 )) || ( ((num+=1)) )
			done
		elif [ "$root" == "RUN_AS_ROOT=no" ] || [ "$root" == "RUN_AS_ROOT=null" ]; then
			echo -e "\nAttempting to uninstall. Please wait . . .\n"
			sent=0
			num=1
			while [ "$sent" == "0" ]; do
				echo -e "\nTry $num . . .\n"
				if [ "$num" == "1" ]; then
					opt="remove"
				elif [ "$num" == "2" ]; then
					opt="--remove"
				elif [ "$num" == "3" ]; then
					opt="uninstall"
				elif [ "$num" == "4" ]; then
					opt="--uninstall"
				else
					echo -e "\nAll other options on the install script have failed. Please look online for documentation on how to remove this app.\nWe are sorry for any inconvenience.\n" && exit 2
				fi
				sleep 3s
				(( exec $(pwd)/"$run" "$opt" ) && ( sent=1 )) || ( ((num+=1)) )
			done
		else
			echo -e "\nWe're sorry. The function gitremove in /bin/mrai has encountered an error. Please contact the devs for help.\n" && exit 2
		fi
	else
		echo -e "\nWe're sorry. The function gitremove in /bin/mrai has encountered an error. Please contact the devs for help.\n" && exit 2
	fi
			
			
}

flatremove () {
	flatpak remove "$pass"
}

snapremove () {
	snap remove "$pass"
}

gitupdate () {
	if [ "$pass" == " " ] || [ "$pass" == "" ]; then
		echo -e "\nNo Apps installed from GitHub through mrai.\n"
		return 0
	fi
	cd "$cache"
	for each in "$pass"; do
		pass1="$each"
		if $( ls | grep -q '$z'); then
			cd "$pass1"
			flag=$(ls | grep ".flag")
			root=$(cat $flag | grep "RUN_AS_ROOT=")
			add=$(cat $flag | grep "ADDRESS=")
			call=$(echo $add | sed 's/ADDRESS=//')
			run=$(cat $flag | grep "RUN=")
			run=$(echo $run | sed 's/RUN=//')
			back=$(pwd)
			del=$(find -type f -name "*.deb")
			cd $HOME/.mrai/"$pass1"
			if $(echo "$call" | grep -q 'https://github.com/') || $(echo "$call" | grep -q 'http://github.com/'); then
				git clone "$call"
			elif $(echo "$call" | grep -q 'github.com/'); then
	        		git clone https://$call
			else
				git clone https://github.com/$call
			fi
			if [[ -z $run ]]; then
				make update || make && make install || echo -e "\nMakefile update method failed.\n"
				rm "$back"/"$del"
				deb=$(find -type f -name "*.deb")
				cp "$deb" "$gitautocache"/"$pass1"
			else
				if [ "$root" == "RUN_AS_ROOT=yes" ]; then
					pkexec $(pwd)/$run $opt
					pkexec checkinstall
					rm "$back"/"$del"
					deb=$(find -type f -name "*.deb")
					cp "$deb" "$gitautocache"/"$pass1"
				elif [ "$root" == "RUN_AS_ROOT=no" ] || [ "$root" == "RUN_AS_ROOT=null" ]; then
					exec $(pwd)/$run $opt
					pkexec checkinstall
					rm "$back"/"$del"
					deb=$(find -type f -name "*.deb")
					cp "$deb" "$gitautocache"/"$pass1"
					if [ "$root" == "RUN_AS_ROOT=null" ]; then
						read -p "Should this be run as root in the future? [y/N]: " ans
						if [ "$ans" == "y" ] || [ "$ans" == "Y" ]; then
							sed -i 's/RUN_AS_ROOT=null/RUN_AS_ROOT=yes/g' $flag
						elif [ "$ans" == "n" ] || [ "$ans" == "N" ]; then
							sed -i 's/RUN_AS_ROOT=null/RUN_AS_ROOT=no/g' $flag
						else
							echo -e "\nAnswer not recognized. We will ask again next time.\n"
						fi
					fi
				elif [ "$ans" == "cancel" ] || [ "$ans" == "exit" ] || [ "$ans" == "end" ]; then
					echo -e "\nAborting . . .\n" && exit 0
				else
					echo -e "\nInput not recognized. Running without root privileges\n"
					exec $(pwd)/$run $opt
					pkexec checkinstall
					rm "$back"/"$del"
					deb=$(find -type f -name "*.deb")
					cp "$deb" "$gitautocache"/"$pass1"
				fi
			fi
		else
			echo -e "\nThis app does not appear to be installed from GitHub.\n"
		fi
	done
}

flatupdate () {
	if [ -f /etc/mrai/flatpak.flag ]; then
		flatpak update
	fi
}

checkinstalltype () {
	if $(apt list --installed | grep -q "$pass"); then
		type=0
	elif [ -f /etc/mrai/snapd.flag ] && $(snap list | grep -q "$pass"); then
		type=1
	elif [ -f /etc/mrai/flatpak.flag ] && $(flatpak list  | grep -q "$pass"); then
		type=2
	elif $(ls --group-directories-first "$gitautocache" | grep -q "$pass"); then
		type=3
	elif $(ls --group-directories-first "$gitmancache" | grep -q "$pass"); then
		type=4
	else
		type=5
	fi
}

gitautolist () {
	ls --group-directories-first $gitautocache
}

gitmanlist () {
	ls --group-directories-first $gitmancache
}

h="mrai Package Manager: the Multiple Repo App Installer
Usage:

To Install:
   mrai -i {github-username/github-repo-name (or Github URL)} {possible-apt-package-name (or name to be installed under) }

To Remove:
   mrai -r {name-installed-under}

To Update:
   mrai -u {github-username/github-repo-name (or Github URL)} {possible-apt-package-name (or name installed under) }

To Search:
   mrai -S {package-name}

Options:
-i, --install		Install an app, if none of the below options are given, check in the following order:
				Github automatic,
				apt-get,
				snap,
				flatpak,
				Github manual

	-a, --apt	Install just from apt-get. In which case, usage will be:

				mrai -i -a {apt-package-name}

	-g, --git	Install just from Github, In which case, usage will be:
			
				mrai -i -g {/github-username/github-repo-name (or Github URL)}
				
			Under this flag you can also use -m or -a to manually indicate whether to install from GitHub manually or
			automaticlly. Please only use the automatic method if the Repo uses a Makefile to install it's software on your
			system.

	-s, --snap 	Install just from snapd, In which case, usage will be:

				mrai -i -s {snap-name}
	
	-f, --flat	Install as Flatpak, In which case, usage will be:

				mrai -i -f {flatpak-name}

-h, --help		Display this help dialoge and exit.

-r, --remove,		Uninstall an app. {name-installed-under} refers to the name given to refer to the GitHub installation,
  --uninstall			the name of the apt package, the name of the snap, or the name of the flatpak, depending on how it was installed

-S, --search,		Search for an app. For GitHub based apps, this only works if they are installed. To find apps to install from GitHub,
  --find			please vist https://www.github.com
	
	-a, --apt	Search for an app through apt-get

	-s, --snap	Search for an app through snap

	-f, --flat	Search for an app through flatpak

	--ga		Search for an app that was installed using GitHub Automatic Method

	--gm		Search for an app that was installed using GitHub Manual Method

	--git		Search for an app installed from GitHub, regardless of method

-u, --update		Update your software. This may or may not work for packages installed from Github.

	-a, --apt	Update from only apt-get

	-f, --flat	Update from only Flatpak

	-g, --git	Update from only Github"
x="$1"
y="$2"
z="$3"
w="$4"
cache="/etc/mrai"
gitautocache="/etc/mrai/gitauto"
gitmancache="/etc/mrai/gitman"
if [[ "$EUID" == "0" ]]; then
    echo -e "\nPlease do not run mrai with root privleges. This will cause file system issues with the GitHub installations.\n" && exit 2
fi
if [ -z "$x" ] && [ -z "$y" ]; then
	echo -e "\n$h\n"
	exit 1
else
	if [ "$x" == "-i" ] || [ "$x" == "--install" ]; then
		if [ "$y" == "-a" ] || [ "$y" == "--apt" ]; then
			pass="$z"
			aptinstall && exit 0 || exit 2
		elif [ "$y" == "-g" ] || [ "$y" == "--git" ]; then
			if [ "$z" == "-m" ] || [ "$z" == "--manual" ]; then
				pass="$w"
				gitmaninstall && exit 0 || exit 2
			elif [ "$z" == "-a" ] || [ "$z" == "--auto" ]; then
				pass="$w"
				gitautoinst && exit 0 || exit 2
			else
				pass="$z"
				( gitautoinst && exit 0 ) || ( gitmaninstall && exit 1 ) || exit 2
			fi
		elif [ "$y" == "-s" ] || [ "$y" == "--snap" ]; then
			pass="$z"
			snapinstall && exit 0 || exit 2
		elif [ "$y" == "-f" ] || [ "$y" == "--flat" ]; then
			pass="$z"
			flatinstall && exit 0 || exit 2
		else
			echo -e "\nAttempting to install\n"
			pass="$y"	
			{
				aptinstall
			} || {
				snapinstall
			} || {
				flatinstall
			} || {
				pass=$z
				gitautoinst
			} || {
				gitmaninstall
			} || {
				echo -e "\nWe're sorry. All installation methods failed.\nPlease make sure that you have the Github username,\nrepo name, and package name spelled correctly\n"
				exit 2
			}
		fi
	elif [ "$x" == "-r" ] || [ "$x" == "--remove" ] || [ "$x" == "--uninstall" ]; then
		pass="$y"		
		checkinstalltype
		echo "$type"
		if [ "$type" == "0" ]; then
			aptremove
		elif [ "$type" == "1" ]; then
			snapremove
		elif [ "$type" == "2" ]; then
			flatremove
		elif [ "$type" == "3" ]; then
			gitautoremove
		elif [ "$type" == "4" ]; then
			gitmanremove
		elif [ "$type" == "5" ]; then
			echo -e "\nAccording to all our databases, this app is not installed.\n"
			exit 1
		else
			echo -e "\nmrai has encountered an error in function {checkinstalltype}.\nPlease contact Thomas Castleman at draugeros@gmail.com to submit a bug report.\n"
			exit 2
		fi
	elif [ "$x" == "-u" ] || [ "$x" == "--update" ]; then
		if [ "$y" == "-a" ] || [ "$y" == "--apt" ]; then
			pkexec aptupdate
		elif [ "$y" == "-f" ] || [ "$y" == "--flat" ]; then
			flatupdate
		elif [ "$y" == "-g" ] || [ "$y" == "--git" ]; then
			if [ -z $z ]; then
				pass="$z"
			else
				t=$(gitautolist)
				r=$(gitmanlist)
				pass="$t $r"
			fi
			gitupdate
		else
			pkexec aptupdate
			flatupdate
			t=$(gitautolist)
			r=$(gitmanlist)
			pass="$t $r"
			gitupdate
		fi
	elif [ "$x" == "-h" ] || [ "$x" == "--help" ]; then
		echo -e "\n$h\n"
		exit 0
	elif [ "$x" == "-S" ] || [ "$x" == "--search" ] || [ "$x" == "--find" ]; then
		if [ "$y" == "-a" ] || [ "$y" == "--apt" ]; then
			apt search "$z"
		elif [ "$y" == "-f" ] || [ "$y" == "--flat" ]; then
			flatpak search "$z"
		elif [ "$y" == "-s" ] || [ "$y" == "--snap" ]; then
			snap search "$z"
		elif [ "$y" == "--gm" ]; then
			list=$(gitmanlist | grep "$z")
			echo -e "\n$list\n"
		elif [ "$y" == "--ga" ]; then
			list=$(gitautolist | grep "$z")
			echo -e "\n$list\n"
		elif [ "$y" == "--git" ]; then
			list1=$(gitmanlist | grep "$z")
			list2=$(gitautolist | grep "$z")
			list="$list1 $list2"
			echo -e "\n$list\n"
		else
			list1=$(gitmanlist | grep "$y")
			list2=$(gitautolist | grep "$y")
			echo -e "\nApt packages:\n"
			apt search "$y"
			if [ -f /etc/mrai/flatpak.flag ]; then
				echo -e "\nFlatpak Packages:\n"
				flatpak search "$y"
			fi
			if [ -f /etc/mrai/snapd.flag ]; then
				echo -e "\nSnap Packages:\n"
				snap search "$y"
			fi
			list="Installed through Manual Method:
$list1

Installed through Automatic Method:

$list2

"
			echo -e "\nInstalled GitHub Apps:\n"
			if [ "$list" == " " ]; then
				echo -e "No matching GitHub Apps Installed.\n"
			else
				echo "$list"
			fi
		fi
	else
		echo -e "\We're sorry. mrai encountered a core error.\nPlease contact Thomas Castleman at draugeros@gmail.com to submit a bug report.\n"
	fi
fi
